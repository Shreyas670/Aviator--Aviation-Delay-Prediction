CREATE OR REPLACE STAGE RAW.QR_BI_DATA.QR_STAGE_INCR
URL='s3://aviatorkipithon/QR_INCR/'
STORAGE_INTEGRATION=S3_AVIATOR;

CREATE OR REPLACE PIPE RAW.QR_BI_DATA.QR_INCR_PIPE
  AUTO_INGEST = TRUE
  AS
  COPY INTO RAW.QR_BI_DATA.TRIP_STATS_INCR
  FROM @RAW.QR_BI_DATA.QR_STAGE_INCR
  FILE_FORMAT = (FORMAT_NAME = QR_CSV);

CREATE OR REPLACE STREAM RAW.QR_BI_DATA.QR_STREAM ON TABLE RAW.QR_BI_DATA.TRIP_STATS_INCR
SHOW_INITIAL_ROWS = TRUE;

CREATE TASK RAW.QR_BI_DATA.QR_INCR_TASK
  WAREHOUSE = compute_wh
  SCHEDULE = '180 minute'
  WHEN
    SYSTEM$STREAM_HAS_DATA('RAW.QR_BI_DATA.QR_STREAM')
  AS
    INSERT INTO         
CONSUMPTION.QR_BI_DATA.TRIP_STATS(TRIP_ID,TRIP_DT,AIR_ID,FLIGHT_ID,SRC_IATA_CODE,DES_IATA_CODE,PAX_CNT_ID,PAX_REV_ID,EXT_REV_ID,TOTAL_REVENUE,ASKMS,RPKMS,SEAT_FACTOR,CAPACITY,MANAGER_ID,PRC_ANLYST_ID,FA_ID) SELECT TRIP_ID,TRIP_DT,AIR_ID,FLIGHT_ID,SRC_IATA_CODE,DES_IATA_CODE,PAX_CNT_ID,PAX_REV_ID,EXT_REV_ID,TOTAL_REVENUE,ASKMS,RPKMS,SEAT_FACTOR,CAPACITY,MANAGER_ID,PRC_ANLYST_ID,FA_ID FROM RAW.QR_BI_DATA.QR_STREAM WHERE METADATA$ACTION = 'INSERT';

ALTER TASK RAW.QR_BI_DATA.QR_INCR_TASK RESUME;

SELECT * FROM TABLE (information_schema.TASK_HISTORY(TASK_NAME => 'QR_INCR_TASK'));